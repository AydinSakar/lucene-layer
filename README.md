# FoundationDB Lucene Layer

This layer provides two integration points with Lucene, `FDBDirectory` and 
`FDBCodec`. These are full implementations of the
[Directory](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/store/Directory.html)
and
[Codec](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/codecs/Codec.html)
interfaces, respectively, and backed entirely by
[FoundationDB](https://foundationdb.com/).

`FDBDirectory` can be used on it's, with the default `Codec` doing the 
interesting work, and will store the files generated by Lucene in the database
instead of the filesystem.

`FDBCodec`, which must be used in conjunction with `FDBDirectory`, implements 
new serialization and data models for Lucene. This results in explicit keys and
values in the database instead of file-like blobs.


## FDBCodec Data Model

The [Subspace](https://foundationdb.com/documentation/data-modeling.html#subspaces-of-keys)
concept is used extensively to provide a simple logical mapping along with easy
storage and  retrieval. Each directory, segment and format are identified by a
unique string. These identifier strings are then  concatenated together
resulting in key ranges associated with each logical element being stored.

For example, assume we have an `FDBDirectory` created with the path
`("lucene")` and a segment named `"_0"`. That would result in the following
[Tuples](https://foundationdb.com/documentation/data-modeling.html#tuples):

- `("lucene", "_0", "dat")` for DocValues
- `("lucene", "_0", "inf")` for FieldInfos
- `("lucene", "_0", "liv")` for LiveDocs
- _etc_

Additional keys and values exist under each of those subspaces for storing the 
actual information associated with each format. In the documentation below,
the full subspace is the concatenation of the directory, segment and format's.


### DocValuesFormat

Stores and retrieves strongly typed, per document values. See
[DocValues](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/index/DocValues.html)
and
[FieldInfo.DocValuesType](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/index/FieldInfo.DocValuesType.html),

Subspace: `("dat")`

- `DocValuesType.BINARY`
    - `(str_fieldName, long_numericOrdinal, long_docID0)` => `(bytes_value)`
    - `(str_fieldName, long_numericOrdinal, long_docID1)` => `(bytes_value)`
    - _..._
- `DocValuesType.NUMERIC`
    - `(str_fieldName, long_numericOrdinal, long_docID0)` => `(long_value)`
    - `(str_fieldName, long_numericOrdinal, long_docID1)` => `(long_value)`
    - _..._
- `DocValuesType.SORTED`
    - `(str_fieldName, long_sortedOrdinal, "bytes", long_ordinal0)` => `(bytes_value)`
    - `(str_fieldName, long_sortedOrdinal, "bytes", long_ordinal1)` => `(bytes_value)`
    - _..._
    - `(str_fieldName, long_sortedOrdinal, "ord", long_docID0)` => `(long_ordinal)`
    - `(str_fieldName, long_sortedOrdinal, "ord", long_docID1)` => `(long_ordinal)`
    - _..._
- `DocValuesType.SORTED_SET`
    - `(str_fieldName, long_sortedSetOrdinal, "bytes", long_ordinal0)` => `(bytes_bytes)`
    - `(str_fieldName, long_sortedSetOrdinal, "bytes", long_ordinal1)` => `(bytes_bytes)`
    - _..._
    - `(str_fieldName, long_sortedSetOrdinal, "doc_ord", long_docID0, long_ordinal0)` => `()`
    - `(str_fieldName, long_sortedSetOrdinal, "doc_ord", long_docID0, long_ordinal1)` => `()`
    - `(str_fieldName, long_sortedSetOrdinal, "doc_ord", long_docID1, long_ordinal0)` => `()`
    - _..._


### FieldInfosFormat

Subspace: `("inf")`

### LiveDocsFormat

Subspace: `("inf")`

### NormsFormat

Subspace: `("len")`

### SegmentInfoFormat

Subspace: `("si")`

### StoredFieldsFormat

Subspace: `("fld")`

### TermVectorsFormat

Subspace: `("vec")`


## Running Tests

[Maven](http://maven.apache.org/) is used for building, packaging and running 
tests.

`$ mvn test`


## Running Lucene and Solr Tests

1. Package fdb-lucene-layer

        $ mvn package

2. Download the Solr source

        $ curl -O 
http://mirror.nexcess.net/apache/lucene/solr/4.4.0/solr-4.4.0-src.tgz
        $ tar xzf solr-4.4.0-src.tgz
        $ cd solr-4.4.0/

3. Run the full test suite

        $ ant test -Dtests.codec=FDBCodec \
                   -Dtests.directory=com.foundationdb.lucene.FDBTestDirectory \
                   -lib  ../target/fdb-lucene-layer-0.0.1-SNAPSHOT.jar \
                   -lib ../target/dependency/fdb-java-1.0.0.jar


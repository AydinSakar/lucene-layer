# FoundationDB Lucene Layer

This layer provides two integration points with Lucene, `FDBDirectory` and 
`FDBCodec`. These are full implementations of the [Directory](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/store/Directory.html)
and [Codec](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/codecs/Codec.html)
interfaces, respectively, and backed entirely by [FoundationDB](https://foundationdb.com/).

`FDBDirectory` can be used on it's, with the default `Codec` doing the 
interesting work, and will store the files generated by Lucene in the database
instead of the filesystem.

`FDBCodec`, which must be used in conjunction with `FDBDirectory`, implements 
new serialization and data models for Lucene. This results in explicit keys and
values in the database instead of file-like blobs.


## FDBCodec Data Model

The [Subspace](https://foundationdb.com/documentation/data-modeling.html#subspaces-of-keys)
concept is used extensively to provide a simple logical mapping and easy
storage and retrieval. Each directory, segment and format are identified by a
unique string. These identifier strings are then concatenated together to yield
key ranges associated with each logical element being stored.

For example, assume we have an `FDBDirectory` created with the path
`("lucene")` and a segment named `"_0"`. That would result in the following
[Tuples](https://foundationdb.com/documentation/data-modeling.html#tuples):

- `("lucene", "_0", "dat")` for DocValues
- `("lucene", "_0", "inf")` for FieldInfos
- `("lucene", "_0", "liv")` for LiveDocs
- _etc_

Additional keys and values exist under each of those subspaces for storing the 
actual information associated with each format. In the documentation below,
the full subspace is the concatenation of the directory, segment and format's.


### DocValuesFormat

Encodes/decodes strongly typed, per document values. See
[DocValuesFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/DocValuesFormat.html),
[DocValues](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/index/DocValues.html)
and
[FieldInfo.DocValuesType](https://lucene.apache.org/core/4_4_0/core/org/apache/lucene/index/FieldInfo.DocValuesType.html):

Subspace: `("dat")`

- `DocValuesType.BINARY`
    - `(str_fieldName, long_numericOrdinal, long_docID0)` => `(bytes_value)`
    - `(str_fieldName, long_numericOrdinal, long_docID1)` => `(bytes_value)`
    - _..._
- `DocValuesType.NUMERIC`
    - `(str_fieldName, long_numericOrdinal, long_docID0)` => `(long_value)`
    - `(str_fieldName, long_numericOrdinal, long_docID1)` => `(long_value)`
    - _..._
- `DocValuesType.SORTED`
    - `(str_fieldName, long_sortedOrdinal, "bytes", long_ordinal0)` => `(bytes_value)`
    - `(str_fieldName, long_sortedOrdinal, "bytes", long_ordinal1)` => `(bytes_value)`
    - _..._
    - `(str_fieldName, long_sortedOrdinal, "ord", long_docID0)` => `(long_ordinal)`
    - `(str_fieldName, long_sortedOrdinal, "ord", long_docID1)` => `(long_ordinal)`
    - _..._
- `DocValuesType.SORTED_SET`
    - `(str_fieldName, long_sortedSetOrdinal, "bytes", long_ordinal0)` => `(bytes_bytes)`
    - `(str_fieldName, long_sortedSetOrdinal, "bytes", long_ordinal1)` => `(bytes_bytes)`
    - _..._
    - `(str_fieldName, long_sortedSetOrdinal, "doc_ord", long_docID0, long_ordinal0)` => `()`
    - `(str_fieldName, long_sortedSetOrdinal, "doc_ord", long_docID0, long_ordinal1)` => `()`
    - `(str_fieldName, long_sortedSetOrdinal, "doc_ord", long_docID1, long_ordinal0)` => `()`
    - _..._


### FieldInfosFormat

Encodes/decodes filed metadata. See
[FieldInfosFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/FieldInfosFormat.html)
and
[FieldInfos](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/index/FieldInfos.html):

Subspace: `("inf")`

- `(long_fieldNum0, "name")` => `(string_fieldName)`
- `(long_fieldNum0, "has_index")` => `(boolean_value)`
- `(long_fieldNum0, "has_payloads")` => `(boolean_value)`
- `(long_fieldNum0, "has_norms")` => `(boolean_value)`
- `(long_fieldNum0, "has_vectors")` => `(boolean_value)`
- `(long_fieldNum0, "doc_values_type")` => `(string_docValuesType)`
- `(long_fieldNum0, "norms_type")` => `(string_normsType)`
- `(long_fieldNum0, "index_options")` => `(string_indexOptions)`
- `(long_fieldNum0, "attr", "attrKey0")` => `(string_attrValue0)`
- `(long_fieldNum0, "attr", "attrKey1")` => `(string_attrValue1)`
- _..._
- `(long_fieldNum1, "name")` => `(string_fieldName)`
- _..._


### LiveDocsFormat

Encodes/decodes live-ness of documents. See
[LiveDocsFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/LiveDocsFormat.html).

Subspace: `("liv")`

- `(long_liveGeneration0)` => `(long_totalSize)`
- `(long_liveGeneration0, long_setBitIndex0)` => `()`
- `(long_liveGeneration0, long_setBitIndex0)` => `()`
- `(long_liveGeneration1)` => `(long_totalSize)`
- _..._


### NormsFormat

Encodes/decodes per-document score normalization values. See
[NormsFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/NormsFormat.html).

Subspace: `("len")`

_See `DocValuesFormat`. Different subspace extension, otherwise the same.


### PostingsFormat

Encodes/decodes terms, postings, and proximity data. See
[PostingsFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/PostingsFormat.html).

Subspace: `("pst")`

- `(long_fieldNum, bytes_term0, "numDocs")` => `(littleEndianLong_value)`
- `(long_fieldNum, bytes_term0, long_doc0)` => `(long_termDocFreq)`
- `(long_fieldNum, bytes_term0, long_doc0, long_pos0)` => `(long_startOffset, long_endOffset, bytes_payload)`
- _..._
- `(long_fieldNum, bytes_term1, "numDocs")` => `(littleEndianLong_value)`
- _..._


### SegmentInfoFormat

Encodes/decodes segment metadata. See
[SegmentInfoFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/SegmentInfoFormat.html).

Subspace: `("si")`

- `("doc_count")`=> `(long_docCount)`
- `("is_compound_file")` => `(boolean_value)`
- `("version")` => `(long_version)`
- `("attr", string_attr0)` => `(string_value)`
- `("attr", string_attr1)` => `(string_value)`
- _..._
- `("diag", string_diag0)` => `(string_value)`
- `("diag", string_diag1)` => `(string_value)`
- _..._
- `("file", string_file0)` => `()`
- `("file", string_file1)` => `()`
- _..._


### StoredFieldsFormat

Encodes/decodes per-document fields. See
[StoredFieldsFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/SegmentInfoFormat.html).

The key parts `long_TYPE` and `long_DATA` below refer to constants in the code, currently `0` and `1`.

Subspace: `("fld")`

- `(long_docID0, long_TYPE, fieldNum0)` => `(string_typeName, long_dataIndex)`
- `(long_docID0, long_TYPE, fieldNum1)` => `(string_typeName, long_dataIndex)`
- _..._
- `(long_docID0, long_DATA, fieldNum0, long_dataIndex, long_offset0)` => `(bytes_value)`
- `(long_docID0, long_DATA, fieldNum0, long_dataIndex, long_offset1)` => `(bytes_value)`
- `(long_docID0, long_DATA, fieldNum1, long_dataIndex, long_offset0)` => `(bytes_value)`
- _..._
- `(long_docID1, long_TYPE, fieldNum0)` => `(string_typeName, long_dataIndex)`


### TermVectorsFormat

Encodes/decodes per-document term vectors. See
[TermVectorsFormat](https://lucene.apache.org/core/4_0_0/core/org/apache/lucene/codecs/TermVectorsFormat.html).

Subspace: `("vec")`

- `(long_doc0, "field", string_field0)` => `(long_fieldNum, long_numTerms, boolean_hasPositions, boolean_hasOffsets, boolean_hasPayloads)`
- `(long_doc0, "field", string_field1)` => `(long_fieldNum, long_numTerms, boolean_hasPositions, boolean_hasOffsets, boolean_hasPayloads)`
- _..._
- `(long_doc0, "term", string_field0, bytes_term0)` => `(long_freq)`
- `(long_doc0, "term", string_field0, bytes_term0, long_pos0)` => `(long_startOffset, long_endOffset, bytes_payload)`
- `(long_doc0, "term", string_field0, bytes_term0, long_pos1)` => `(long_startOffset, long_endOffset, bytes_payload)`
- `(long_doc0, "term", string_field0, bytes_term1)` => `(long_freq)`
- _..._
- `(long_docNum, "field", string_fieldName0)` => `(long_fieldNum, long_numTerms, boolean_hasPositions, boolean_hasOffsets, boolean_hasPayloads)`
- _..._


## Running Built-In Tests

[Maven](http://maven.apache.org/) is used for building, packaging and running
tests.

`$ mvn test`


## Running Lucene and Solr Tests

1. Package fdb-lucene-layer

        $ mvn package

2. Download the Solr source

        $ curl -O http://mirror.nexcess.net/apache/lucene/solr/4.4.0/solr-4.4.0-src.tgz
        $ tar xzf solr-4.4.0-src.tgz
        $ cd solr-4.4.0/

3. Run the full test suite

        $ ant test -Dtests.codec=FDBCodec \
                   -Dtests.directory=com.foundationdb.lucene.FDBTestDirectory \
                   -lib  ../target/fdb-lucene-layer-0.0.1-SNAPSHOT.jar \
                   -lib ../target/dependency/fdb-java-1.0.0.jar
